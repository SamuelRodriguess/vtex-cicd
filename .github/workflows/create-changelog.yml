name: Generate Changelog

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write  # Necess√°rio para comitar CHANGELOG.md
  pull-requests: write

jobs:
  generate-changelog:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Busca hist√≥rico completo para gerar changelog correto

    - name: Setup git-chglog
      run: |
        CHGLOG_VERSION="0.9.1"
        curl -Lo git-chglog https://github.com/git-chglog/git-chglog/releases/download/${CHGLOG_VERSION}/git-chglog_linux_amd64
        chmod +x git-chglog

    - name: Generate CHANGELOG.md
      id: generate
      run: |
        rm -f CHANGELOG.md
        ./git-chglog -o CHANGELOG.md
        if git diff --quiet CHANGELOG.md; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup
      run: rm git-chglog
      if: always()

    - name: Create Pull Request with Changelog updates
      if: steps.generate.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update CHANGELOG.md"
        title: "üìù Update Changelog"
        body: |
          This pull request updates the CHANGELOG.md to include all recent changes.
          - Generated automatically by git-chglog and GitHub Actions.
          - Trigger: ${{ github.event_name }}
        branch: update-changelog-${{ github.run_id }}
        base: main
        delete-branch: true
        labels: documentation, automated-pr

    - name: Enable Auto-merge on PR
      if: steps.generate.outputs.changes == 'true'
      run: |
        gh pr merge --auto --merge "${{ steps.create-pull-request.outputs.pull-request-number }}"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
